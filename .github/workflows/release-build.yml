name: Build Release APK

on:
  release:
    types: [created]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: 设置 Android SDK
      uses: android-actions/setup-android@v3
      
    - name: 缓存 Gradle 依赖
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
      
    - name: 授予 gradlew 执行权限
      run: chmod +x gradlew
      
    - name: 解码 Keystore 文件
      run: |
        if [ -n "${{ secrets.KEYSTORE_FILE_BASE64 }}" ]; then
          echo "解码 keystore 文件..."
          # 去除 Base64 字符串中的换行符和空格
          echo "${{ secrets.KEYSTORE_FILE_BASE64 }}" | tr -d '\n\r ' | base64 -d > app/release-key.jks
          
          # 验证文件是否创建成功
          if [ ! -f app/release-key.jks ]; then
            echo "错误: keystore 文件创建失败"
            exit 1
          fi
          
          FILE_SIZE=$(stat -c%s app/release-key.jks 2>/dev/null || echo "0")
          if [ "$FILE_SIZE" -eq 0 ]; then
            echo "错误: keystore 文件大小为 0，Base64 解码可能失败"
            exit 1
          fi
          
          echo "✓ keystore 文件创建成功，大小: ${FILE_SIZE} 字节"
        else
          echo "⚠ 未设置 KEYSTORE_FILE_BASE64 Secret，将使用未签名的 APK"
        fi
      
    - name: 构建 Release APK
      run: |
        if [ -f app/release-key.jks ] && \
           [ -n "${{ secrets.KEYSTORE_PASSWORD }}" ] && \
           [ -n "${{ secrets.KEY_ALIAS }}" ] && \
           [ -n "${{ secrets.KEY_PASSWORD }}" ]; then
          echo "使用注入签名属性构建签名 APK..."
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$(pwd)/app/release-key.jks \
            -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }} \
            --no-daemon
        else
          echo "构建未签名的 APK..."
          ./gradlew assembleRelease --no-daemon
        fi
      
    - name: 上传 APK 到 Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.release.tag_name }}
        files: app/build/outputs/apk/release/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 清理敏感文件
      if: always()
      run: |
        if [ -f app/release-key.jks ]; then
          echo "清理 keystore 文件..."
          rm -f app/release-key.jks
          echo "✓ keystore 文件已删除"
        fi

